var async = require('async');
var db = require('mongo_schemas');
//todo:it should be top rated and recommended movie 
exports.get_recommended = function(userId, cb) {
    async.waterfall([
        function find_movie_indexes(cb) {
            db.rates.findOne({
                user_id: userId
            }, {
                recom_movie: true
            }).lean().exec(function(err, topRated) {
                if (err) {
                    console.mongo('Error', err);
                    return (cb(err, null));
                }
                let res_data = {};
                res_data.status = true;
                res_data.topRated = topRated.recom_movie;
                console.log(res_data);
                return (cb(null, res_data));
            });
        },
        function find_movie_title(res_data, cb) {
            let result = [];
            async.each(res_data.topRated, function(index, cb) {
                db.movie_info.findOne({
                    'movie_id': index
                }).lean().exec(function(err, info) {
                    if (err) {
                        console.mongo('Error', err);
                        cb(err);
                    }
                    result.push(info);
                    cb();
                });
            }, function(err) {
                if (err) {
                    console.mongo('Error', err);
                    return (cb(err, null));
                }
                res_data.status = true;
                res_data.recom_movie = result;
                return (cb(null, res_data));
            });
        }
    ], function(err, result) {
        if (err) {
            return (cb(err, null));
        }
        return (cb(null, err));
    });
}
